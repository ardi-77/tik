<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guru</title>

    <link rel="stylesheet" href="style.css">

    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="page-container-full">
        <div class="header">
            <h1>Student Tasks | Dashboard</h1>
            <div class="header-actions">
                <button id="exportPdf" class="primary-btn">Export PDF</button>
                <button id="hapusSemua" class="warning-btn">Reset All</button>
                <button id="logoutButton" class="danger-btn">Logout</button>
            </div>
        </div>

        <div class="filter-container">
            <div class="filter-item">
                <label for="filterKelas">Kelas:</label>
                <select id="filterKelas"><option value="">All</option></select>
            </div>
            <div class="filter-item">
                <label for="filterNilai">Status:</label>
                <select id="filterNilai">
                    <option value="">All</option>
                    <option value="dinilai">Sudah Dinilai</option>
                    <option value="belum_dinilai">Belum Dinilai</option>
                </select>
            </div>
            <div class="filter-item">
                <label for="filterTanggalMulai">Start:</label>
                <input type="date" id="filterTanggalMulai">
            </div>
            <div class="filter-item">
                <label for="filterTanggalSampai">Finish:</label>
                <input type="date" id="filterTanggalSampai">
            </div>
            <div class="filter-buttons">
                <button id="applyFilter" class="btn-filter apply">Terapkan</button>
                <button id="resetFilter" class="btn-filter reset">Reset</button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table id="tabelTugas" class="simple-table">
                <thead>
                    <tr>
                        <th>Tanggal Kirim</th>
                        <th>Nama Siswa</th>
                        <th>Kelas</th>
                        <th>Nama Tugas</th>
                        <th>Nilai</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Detail Tugas</h2>
            <table class="modal-table">
                <tr><td class="label">Nama</td><td id="modalStudentName"></td></tr>
                <tr><td class="label">Kelas</td><td id="modalStudentClass"></td></tr>
                <tr><td class="label">Tugas</td><td id="modalTaskName"></td></tr>
                <tr><td class="label" style="vertical-align: top;">Deskripsi</td><td id="modalTaskDesc" style="white-space: pre-wrap;"></td></tr>
            </table>
            <div class="modal-image-container"><p><strong>File Terkirim:</strong></p><img id="modalTaskImage" src="" alt="File Tugas Siswa"></div>
            <div class="grading-form"><h3>Beri Nilai</h3><input type="number" id="modalInputNilai" min="50" max="100" placeholder="50-100"><button id="modalSimpanNilai">Simpan Nilai</button></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/umd/simple-datatables.js" type="text/javascript"></script>

    <script>
        // --- REVISI: Seluruh skrip dibungkus dalam DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', function() {
            // Cek sesi login guru
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser || currentUser.role !== 'guru') {
                window.location.href = 'index.html';
                return; // Hentikan eksekusi jika tidak login
            }

            const modal = document.getElementById('detailModal');
            let dataTable;
            let currentFilteredTasks = [];

            function formatTanggal(isoString) {
                if (!isoString) return 'N/A';
                const d = new Date(isoString);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                const hours = String(d.getHours()).padStart(2, '0');
                const minutes = String(d.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} - ${hours}:${minutes}`;
            }
            
            function renderAndInitTable() {
                if (dataTable) dataTable.destroy();

                const allTasks = JSON.parse(localStorage.getItem('studentTasks')) || [];
                const tableBody = document.querySelector("#tabelTugas tbody");
                
                const filterKelasValue = document.getElementById('filterKelas').value;
                const filterNilaiValue = document.getElementById('filterNilai').value;
                const filterTanggalMulaiValue = document.getElementById('filterTanggalMulai').value;
                const filterTanggalSampaiValue = document.getElementById('filterTanggalSampai').value;

                currentFilteredTasks = allTasks.filter(task => {
                    const kelasMatch = !filterKelasValue || task.kelasSiswa === filterKelasValue;
                    let nilaiMatch = true;
                    if (filterNilaiValue === 'dinilai') nilaiMatch = task.nilai !== 'Belum Dinilai';
                    else if (filterNilaiValue === 'belum_dinilai') nilaiMatch = task.nilai === 'Belum Dinilai';
                    let tanggalMatch = true;
                    const taskDate = new Date(task.timestamp);
                    taskDate.setHours(0, 0, 0, 0); 
                    if (filterTanggalMulaiValue) {
                        const startDate = new Date(filterTanggalMulaiValue);
                        if (taskDate < startDate) tanggalMatch = false;
                    }
                    if (filterTanggalSampaiValue) {
                        const endDate = new Date(filterTanggalSampaiValue);
                        if (taskDate > endDate) tanggalMatch = false;
                    }
                    return kelasMatch && nilaiMatch && tanggalMatch;
                });

                tableBody.innerHTML = '';
                const sortedTasks = currentFilteredTasks.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (sortedTasks.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6">Tidak ada data yang cocok dengan filter.</td></tr>';
                } else {
                    sortedTasks.forEach(task => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatTanggal(task.timestamp)}</td>
                            <td>${task.namaSiswa}</td>
                            <td>${task.kelasSiswa}</td>
                            <td>${task.namaTugas}</td>
                            <td>${task.nilai}</td>
                            <td>
                                <div class="action-cell">
                                    <button class="action-btn view-btn" data-task-id="${task.id}">Lihat</button>
                                    <button class="action-btn delete-btn" data-task-id="${task.id}">Hapus</button>
                                </div>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }

                dataTable = new simpleDatatables.DataTable("#tabelTugas", {
                    perPage: 5,
                    perPageSelect: [5, 10, 20, 50],
                    searchable: true,
                    labels: {
                        placeholder: "Pencarian...",
                        perPage: "",
                        noRows: "Tidak ada data tugas yang cocok.",
                        info: "Menampilkan {start} - {end} dari {rows}",
                    }
                });
            }
            
            function populateFilterKelas() {
                const allTasks = JSON.parse(localStorage.getItem('studentTasks')) || [];
                const filterSelect = document.getElementById('filterKelas');
                const kelasSet = new Set(allTasks.map(task => task.kelasSiswa));
                filterSelect.innerHTML = '<option value="">All</option>';
                kelasSet.forEach(kelas => {
                    filterSelect.add(new Option(kelas, kelas));
                });
            }

            function openDetailModal(taskId) {
                const allTasks = JSON.parse(localStorage.getItem('studentTasks')) || [];
                const task = allTasks.find(t => t.id === taskId);
                if (!task) return;
                document.getElementById('modalStudentName').textContent = task.namaSiswa;
                document.getElementById('modalStudentClass').textContent = task.kelasSiswa;
                document.getElementById('modalTaskName').textContent = task.namaTugas;
                document.getElementById('modalTaskDesc').textContent = task.deskripsi;
                document.getElementById('modalTaskImage').src = task.file;
                document.getElementById('modalInputNilai').value = (task.nilai !== 'Belum Dinilai') ? task.nilai : '';
                document.getElementById('modalSimpanNilai').dataset.taskId = taskId;
                modal.style.display = 'block';
            }

            function deleteTask(taskId) {
                Swal.fire({
                    title: 'Anda yakin?', text: "Tugas yang dihapus tidak dapat dikembalikan!", icon: 'warning',
                    showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33',
                    confirmButtonText: 'Ya, hapus!', cancelButtonText: 'Batal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        let tasks = JSON.parse(localStorage.getItem('studentTasks')) || [];
                        localStorage.setItem('studentTasks', JSON.stringify(tasks.filter(t => t.id !== taskId)));
                        renderAndInitTable();
                        Swal.fire('Terhapus!', 'Data tugas telah dihapus.', 'success');
                    }
                });
            }

            function saveGradeFromModal() {
                const taskId = parseInt(this.dataset.taskId);
                const nilai = parseInt(document.getElementById('modalInputNilai').value);
                if (nilai >= 50 && nilai <= 100) {
                    let tasks = JSON.parse(localStorage.getItem('studentTasks')) || [];
                    const taskIndex = tasks.findIndex(t => t.id === taskId);
                    if (taskIndex > -1) {
                        tasks[taskIndex].nilai = nilai;
                        localStorage.setItem('studentTasks', JSON.stringify(tasks));
                        modal.style.display = 'none';
                        renderAndInitTable();
                    }
                } else {
                    alert('Masukkan nilai antara 50 dan 100.');
                }
            }

            function exportTableToPDF() {
                if (currentFilteredTasks.length === 0) {
                    Swal.fire('Gagal Export', 'Tidak ada data untuk diekspor.', 'warning');
                    return;
                }

                Swal.fire({
                    title: 'Membuat PDF...',
                    text: 'Mohon tunggu sebentar.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const pdfContainer = document.createElement('div');
                let tableHTML = `
                    <style>
                        body { font-family: sans-serif; }
                        table { border-collapse: collapse; width: 100%; font-size: 12px; }
                        th { border: 1px solid #dddddd; text-align: center; padding: 12px; background-color: #f2f2f2; }
                        td { border: 1px solid #dddddd; text-align: left; padding: 8px; }                        
                        h1 { font-size: 24px; text-align: center; margin-bottom: 20px;}
                    </style>
                    <h1>Laporan Penilaian Tugas Siswa</h1>
                    <p>Tanggal Export: ${new Date().toLocaleDateString('id-ID')}</p><br/>
                    <table>
                        <thead>
                            <tr>
                                <th width="12%">Tanggal Kirim</th>
                                <th>Nama Siswa</th>
                                <th width="8%">Kelas</th>
                                <th>Nama Tugas</th>
                                <th width="8%">Nilai</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    currentFilteredTasks.forEach(task => {
                        tableHTML += `
                        <tr>
                            <td style="text-align:center">${formatTanggal(task.timestamp)}</td>
                            <td>${task.namaSiswa}</td>
                            <td style="text-align:center">${task.kelasSiswa}</td>
                            <td>${task.namaTugas}</td>
                            <td style="text-align:center">${task.nilai}</td>
                        </tr>
                        `;
                    });
                    tableHTML += '</tbody></table> <br/><p style="font-size:10px">Student Tasks @ 2025</p>';
                pdfContainer.innerHTML = tableHTML;
                document.body.appendChild(pdfContainer);

                setTimeout(() => {
                    const options = {
                        margin:       [0.5, 0.5, 0.5, 0.5],
                        filename:     'Laporan-Tugas-Siswa.pdf',
                        image:        { type: 'jpeg', quality: 0.98 },
                        html2canvas:  { scale: 2, useCORS: true },
                        jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }
                    };

                    html2pdf().from(pdfContainer).set(options).save().then(() => {
                        document.body.removeChild(pdfContainer); 
                        Swal.close();
                    }).catch(err => {
                        document.body.removeChild(pdfContainer);
                        Swal.fire('Error', 'Terjadi kesalahan saat membuat PDF.', 'error');
                        console.error(err);
                    });
                }, 300);
            }
            
            // --- Event Listeners ---
            document.getElementById('logoutButton').addEventListener('click', () => {
                Swal.fire({
                    title: 'Konfirmasi Logout', text: "Apakah Anda yakin ingin keluar?", icon: 'question',
                    showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Ya, Keluar!', cancelButtonText: 'Batal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        sessionStorage.removeItem('currentUser');
                        window.location.href = 'index.html';
                    }
                });
            });
             document.querySelector(".table-responsive").addEventListener('click', (e) => {
                const viewBtn = e.target.closest('.view-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (viewBtn) openDetailModal(parseInt(viewBtn.dataset.taskId));
                if (deleteBtn) deleteTask(parseInt(deleteBtn.dataset.taskId));
            });
            document.getElementById('applyFilter').addEventListener('click', renderAndInitTable);
            document.getElementById('resetFilter').addEventListener('click', () => {
                document.getElementById('filterKelas').value = '';
                document.getElementById('filterNilai').value = '';
                document.getElementById('filterTanggalMulai').value = '';
                document.getElementById('filterTanggalSampai').value = '';
                renderAndInitTable();
            });
            document.getElementById('exportPdf').addEventListener('click', exportTableToPDF);
            modal.querySelector('.close-button').addEventListener('click', () => modal.style.display = 'none');
            window.addEventListener('click', (e) => { if (e.target === modal) { modal.style.display = 'none'; } });
            document.getElementById('modalSimpanNilai').addEventListener('click', saveGradeFromModal);
            document.getElementById('hapusSemua').addEventListener('click', () => {
                Swal.fire({
                    title: 'Anda Yakin Ingin Menghapus SEMUA Data?', text: "Tindakan ini tidak dapat dibatalkan!", icon: 'error',
                    showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Ya, Hapus Semua!', cancelButtonText: 'Batal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.removeItem('studentTasks');
                        renderAndInitTable();
                        Swal.fire('Berhasil!', 'Seluruh data tugas telah dihapus.', 'success');
                    }
                });
            });

            // Inisialisasi Awal
            populateFilterKelas();
            renderAndInitTable();
        });
    </script>
</body>
</html>